---
title: "pneumonia EDA 1"
output: 
  html_document:
    toc: true # table of content true
---

# Intro 
This post is a supplementary material for an assignment. The assignment is part of the Augmented Machine Learning unit for a Specialised Diploma in Data Science for Business. The aim of the assignment is to use `DataRobot` for predictive modelling. Exploratory data analysis and feature engineering will be done here in `R` before the data is imported into `DataRobot`. 
<br>
The dataset is from a [prospective population-based surveillance study](https://bmjopen.bmj.com/content/8/4/e019439.long). The observational study was conducted over 3 different South America cities across 3 different countries over a 3-year period to investigate the incidence rate of Community Acquired Pneumonia (CAP). The dataset has a wealth of variables which can be used for predictive modelling, there is no known predictive analysis published using this dataset. The aim of this project is to classify if patients with CAP became better after seeing a doctor or became worse despite seeing a doctor.  
<br>
```{r message=F}
library(here)
library(tidyverse)
theme_set(theme_light())

raw<- readxl::read_excel(here("CAP","Incidence rate of community-acquired pneumonia in adults a population-based prospective active surveillance study in three cities in South America.xls"))
```
The dataset consists of 2302 rows and 176 columns. 
```{r}
dim(raw)
```

The original column names were the description of the variables (e.g. `Received flu shot in the last 12 months`). Based on these descriptions/column names, the columns can be classified into 13 categories (see table below). Most of the categories ae clinically related variables. 
```{r}
categories13<- readxl::read_excel(here("CAP","Incidence rate of community-acquired pneumonia in adults a population-based prospective active surveillance study in three cities in South America.xls"), sheet=3)

categories13 %>%  DT::datatable(rownames = F, options = list(searchHighlight = TRUE, paging= T))
```

## Data dictionary
The column names are renamed to shorter column names (e.g. `Received flu shot in the last 12 months`-> `flu`) with prefixes to identify which of the above 13 categories they belong to (e.g. `flu`-> `V_flu`. Prefix `V_` stands for vaccine against the flu.).  
```{r}
metadata<- readxl::read_excel(here("CAP","Incidence rate of community-acquired pneumonia in adults a population-based prospective active surveillance study in three cities in South America.xls"), sheet=2)

# metadata
metadata %>%  DT::datatable(rownames = F, options = list(searchHighlight = TRUE, paging= T))

# rename col names 
colnames(raw)<- metadata$`New column name` %>% t()
```

## EDA blueprint 
EDA will be iterated for each of the 13 categories as there are too many columns to do the EDA at once. Also, there may be some association among the variables for each category.  EDA includes exploring (i) the types of variables for each category (ii) the number of missing values (iii) the number of outliers (iv) and data cleaning if needed. Customized functions were created to facilitate EDA: 

1.	`dtype` provides the number of columns  beginning with the prefix  (e.g. `dtype(dataframe, “Pt”)` will list all the columns related to patient (`pt`). The types of variables are also provided. 
2.	`eda_c` breaks down the labels for columns beginning with the prefix. Used mostly for categorical variables.
3.	`eda_n_NAplt` plots the percentage of `NA`/missing values for each column beginning with the prefix. Used mostly for numeric variables.
4.	`eda_n_NAcutoff` provides a vector of variable names with acceptable `NA` values. Used mostly for numeric variables. The ball park maximum amount of missing values is 20% though higher proportion of missing values may be included after inspecting the plot generated by `eda_n_NAplt`
5.	`eda_n_outlier` plots boxplots for numeric variables beginning with the prefix. Variables with large number of outliers can be isolated for further investigation. 

```{r message=F}
dtype<- function(datafr, x){
datafr %>% select(starts_with(x, ignore.case = F)) %>% str()
}

eda_c<- function(datafr,x){
  datafr %>% select(starts_with(x, ignore.case = F)) %>%  map(~ table(.x, useNA = "always"))
}

eda_n_NAplt<- function (datafr, x){
  datafr %>% select(starts_with(x, ignore.case = F)) %>% summarise(across(starts_with(x), ~mean(is.na(.)))) %>% pivot_longer(cols = everything(), names_to= "Variables" , values_to="pct_na") %>% mutate(Variables= fct_reorder(Variables, pct_na)) %>% ggplot(aes(x=Variables, y=pct_na, fill= pct_na))+ geom_col() + coord_flip() + scale_y_continuous(labels=scales::percent_format()) + scale_fill_viridis_c(option = "plasma")}

eda_n_NAcutoff<- function(datafr, x, low, high){
  datafr%>% select(starts_with(x, ignore.case = F)) %>% summarise(across(starts_with(x), ~mean(is.na(.)))) %>% pivot_longer(cols = everything(), names_to="Variables", values_to="pct_na") %>% filter((pct_na>low & pct_na<high)) %>% pull(Variables)}

eda_n_outlier<-function(datafr, x_selected){
# nested df with plots
  plt<-datafr %>% select(all_of(x_selected)) %>% pivot_longer(cols=everything(),names_to="Variables", values_to="values") %>% nest(-Variables) %>% mutate(plot= map2(.x= data, .y= Variables, 
~ggplot(data=.x, aes(x= values)) + geom_boxplot() + labs(title = .y)
)) 
# print the plots
  for (i in 1:length(x_selected)){
    p<-plt[[3]][[i]]
    print(p)}
  }
```

## Outcome
The outcome will be `Other_Outcome`. As the prediction is whether the patient was `better` or `worse` after seeking medical treatment, a binary classification is warranted here. However the `Other_Outcome` has 4 values, namely `cure`, `improvement`, `unfavourable` and `death`.  
```{r}
eda_c(raw, "Other_Outcome")
```
`cure` and `improvement ` will be collapsed as `better` and `unfavourable` and `death` will be collapsed as `worse`.  6 times as many patients became better after seeking medical help. While encouraging from the doctor’s and patient’s perspective, it results in an imbalanced dataset for prediction. The imbalanced dataset will be addressed much later.
<br>
After removing 21 `NA` outcomes, there are 2281 observations remaining.
```{r}
# collapse 4 categories into 2 
raw$Other_Outcome<-fct_collapse(raw$Other_Outcome, better=c("Cure", "Improvement")) 
raw$Other_Outcome<-fct_collapse(raw$Other_Outcome, worse=c("unfavorable", "death"))

# remove na 
df<-raw %>%  filter(!is.na(Other_Outcome))  
eda_c(df, "Other_Outcome")
```
```{r eval=F, include=F }
# raw data for baseline model
library(rsample)
set.seed(69)
s_Raw<-df %>% initial_split(prop = 9/10, strata = Other_Outcome)
s_RawDR<- training(s_Raw)
s_RawUnseen<-testing(s_Raw)

write_excel_csv(s_RawDR, file.path("RawDR.csv"))
write_excel_csv(s_RawUnseen, file.path("RawUnseen.csv"))
```

## Discard the noise
There are column names with the prefix `rm_` in front of the category prefix (e.g. `rm_Other_`). These columns are removed for numerous reasons.
```{r}
dtype(df,"rm")
```
For instance, `1 year status` contains information about the patient’s status one year post CAP which is a data leakage as it reveals the patient’s outcome from the CAP. 
```{r}
df %>% select(rm_Other_1yearstatus) %>% tail()
```
Other columns contained duplicated information. For lab results, there is a column, which indicates if the specific biochemical was tested (eg `rm_Lab_urea`), and another column of the result (eg `Lab_urea`). If the biochemical was not tested, the column will indicate `No` test being done and the result column will be blank. Keeping only the results column will suffice. The reasons for removing specific `rm_` columns is described in the above data dictionary.  
```{r}
df %>% select(rm_Lab_urea, Lab_urea) %>% head()
```
The dataframe of 176 columns ends up with 140 columns after discarding `rm_` columns. 
```{r}
df<-df %>% select(-starts_with("rm"))

ncol(df)
```
<br>

# 1 `Other_` related category 
After removing redundant `Other_` variables, only `Other_Outcome` remains. Rename it to just `Outcome` for readability. 
```{r}
dtype(df, "Other")
df<-df %>% rename(Outcome=Other_Outcome)
```
<br>

# 2 `Pt_`  Patient related category 
```{r}
dtype(df, "Pt")
```

## Appropriate patients 
`Pt_incorrect` and `Pt_correct` are columns to indicate if the patients enrolled met the criteria for the study.  All the subjects met the criteria for the study. `Pt_incorrect` and `Pt_correct` can be dropped. 
```{r}
(df %>% count(Pt_incorrect))
(df %>% count(Pt_correct))

df<-df %>% select(- c(Pt_correct, Pt_incorrect))
```

## Case_number 
Case numbers, `Pt_CaseNumber` are not distinct to the entire dataset. they are only distinct to the research site. Assign new unique case number for entire dataset.
```{r}
# are case number distinct
(df %>% pull(Pt_CaseNumber) %>%  n_distinct())

# explore why case numbers are not distinct
(df %>% filter(Pt_CaseNumber==1))
(df %>% filter(Pt_CaseNumber==11))

#assign unique case numbers 
df<-df %>% mutate(Pt_CaseNumber=1:nrow(df))
(df %>% pull(Pt_CaseNumber) %>%  n_distinct())
```

## Age 
There is no missing age and mostly elderly >60 across all three sites
```{r}
# any m/s age 
(eda_n_NAplt(df, "Pt_Age"))

# distribution of age 
(ggplot(df, aes(Pt_Age)) + geom_histogram(aes(fill=Pt_Site),alpha=.5,bins=round(sqrt(nrow(df)))/3)) +labs(title = "Distribution of Age") + facet_wrap(.~Pt_Site) +theme(legend.position="none") + geom_vline(xintercept = 60, size=1)
```
<br>

# 3 `R_` Radiology related category 
```{r}
dtype(df, "R")
```

##  Effusion and effusion site
`R_CXR_effusion` and `R_CT_effusion` indicates if effusion was seen on the radiological imaging while `R_CXR_effusionSite` and `R_CT_effusionSite` records  the location of the effusion site.  These columns contain different facets of the same information; the values of these columns can be integrated into single columns. 

### On chest x-ray  ( `R_CXR_effusion`, `R_CXR_effusionSite`)
2080 effusion sites on chest x-rays , `R_CXR_effusionSite`,  were recorded as `NA` not because they are truly missing but because these x-rays have no effusion sites in the begin with. They will be relabelled as `nil` effusion sites.  43 effusions sites were recorded as `NA` and whether effusion sites were found the x-rays are unknown. These observations will retain their `NA` values. 9 effusion sites were recorded as `NA` but effusions were detected on x-rays. They will be relabelled as `effusion but ? site`.  
<br> 
After relabelling `R_CXR_effusionSite` using information from `R_CXR_effusion`, the latter column will be removed. 
```{r}
(table(df$R_CXR_effusion, df$R_CXR_effusionSite, useNA = "always"))

# relabel effusion sites
df<-df %>% mutate(R_CXR_effusionSite=case_when(
   R_CXR_effusion=='No' & is.na(R_CXR_effusionSite)~ "Nil", 
    R_CXR_effusion=='Unavailable' & is.na(R_CXR_effusionSite) ~ "Unavailable",
    R_CXR_effusion=="Yes" & is.na(R_CXR_effusionSite) ~"Effusion but ?site", 
    T~as.character(R_CXR_effusionSite)
  ))

(table(df$R_CXR_effusion, df$R_CXR_effusionSite, useNA = "always"))

# remove R_CXR_effusion 
df<-df %>% select(- R_CXR_effusion)
```

### On CT chest (`R_CT_effusion`, `R_CT_effusionSite`) 
Repeat the same for effusion related variables on CT chest. 
```{r}
(table(df$R_CT_effusion, df$R_CT_effusionSite, useNA = "always"))

# relabel effusion site
df<-df %>% mutate(R_CT_effusionSite=case_when(
    R_CT_effusion=='No' & is.na(R_CT_effusionSite)~ "Nil", 
    R_CT_effusion=='Unavailable' & is.na(R_CT_effusionSite) ~ "Unavailable",
    T~as.character(R_CT_effusionSite)
  )) 

(table(df$R_CT_effusion, df$R_CT_effusionSite, useNA = "always"))

#remove CT_effusion 
df<-df %>% select(-R_CT_effusion)
```
<br>

# 4 `SS_` Category related to signs and symptoms of CAP 
`99` days of respiratory symptoms `SS_daysOfRespSymp` are outliers and likely represents missing values Relabel `99` as `NA`. The usage of `99` occurs frequently for numeric variables in this dataset, more examples to follow in later sections.
```{r}
(dtype(df, "SS"))
(eda_c(df, "SS"))
df<-df %>% mutate(SS_daysOfRespSymp=na_if(SS_daysOfRespSymp, 99))
```
<br>

# 5 `Hx_` medical history category 
```{r}
(dtype(df, "Hx"))
(eda_c(df,"Hx"))
```

## HIV details 
Remove `Hx_HIV_CD4` & `Hx_HIV_viralLoad` as there are too many `NA`. Remove `Hx_HIV_Medicine` as there are too many `Unavailable`.
```{r}
df<-df %>% select(-contains("Hx_HIV_"))
```

## Heart disease
`Hx_heart`  indicates whether the patient has heart disease or not. `Hx_heart_type` provides details on the type of heart disease. Both the variables can be integrated into a variable.
<br> 
 1273  observations for heart disease details, `Hx_heart_type` were labelled as `NA` not because they are truly missing but because these patients have `No` heart disease. These values will be labelled as `None`.  19 observations for heart disease details were labelled as `NA` when the heart disease status is `Uncertain`. These values will be labelled as `Query heart disease`. 676 observations for heart disease details were labelled as `NA` but were classified to have a heart disease. As these patients have heart diseases but no details can be obtained, the `NA` values will be treated as `Other` types of heart disease. 
<br> 
After using `Hx_heart` to expand `Hx_heart_type`, `Hx_heart` will be dropped. 
```{r}
(table(df$Hx_heart, df$Hx_heart_type, useNA="always"))

# relabel
df<- df %>% mutate(Hx_heart_type=case_when(
  Hx_heart== "No" & is.na(Hx_heart_type) ~ "None",
  Hx_heart=="Uncertain" & is.na(Hx_heart_type) ~ "Query heart disease", 
  Hx_heart=="Yes" & is.na(Hx_heart_type) ~ "Other",
  T~ Hx_heart_type)) 

(table(df$Hx_heart, df$Hx_heart_type, useNA="always"))

# remove `hx_heart`
df <- df %>% select (-Hx_heart)
```
<br>

# 6 `Social_` social history category 
```{r}
(dtype(df, "Social"))
(eda_c(df, "Social"))
```
## smoking 
`Social_smoke` indicates if the patient smokes or not. `Social_smoke_duration` records how long the patients was smoking. These variables contain different facets of the same information; the values can be integrated into a single column. 
<br>
1276 observations for smoking duration, `Social_smoke_duration` were labelled as `NA` but these values were not truly missing. These patients did not smoke. The values will be relabelled as `non-smoker`.  175 observations for smoking duration were labelled as `NA` but the information if they smoked was `Unavailable`. These values will be relabelled as `Unavailable`.  All the patients who smoked had the duration of their smoking habit recorded. The bins of smoking duration were relabelled to terms that are more intuitive. `current` was relabelled as `still smokes`, `In the last 5 years` was relabelled as `smoked in the last 5y`, `Previous to the last 5 years` was relabelled as `smoked >5y ago`. 
<br> 
After using `Social_smoke` to expand `Social_smoke_duration`, `Social_smoke` is dropped. 
```{r}
(table(df$Social_smoke, df$Social_smoke_duration, useNA = "always"))

# relabel 
df<-df %>% mutate(Social_smoke=case_when(
  Social_smoke=="Yes" & Social_smoke_duration=="current"~ "still smokes", 
  Social_smoke=="Yes" & Social_smoke_duration=="In the last 5 years"~ "smoked in last 5y", 
  Social_smoke=="Yes" & Social_smoke_duration=="Previous to the last 5 years"~ "smoked >5y ago", 
  T~as.character(Social_smoke)
)) 

(df %>% count(Social_smoke))

# remove 
df <- df %>% select(-Social_smoke_duration)
```
<br>

# 7 `HCAP_` healthcare associated pneumonia category 
No data cleaning is needed for this category. 
```{r}
(dtype(df,"HCAP"))
(eda_c(df, "HCAP"))
```
<br>

# 8 `PE_` observations during physical examination category 
```{r}
(dtype(df, "PE"))
# explore categorical 
(eda_c(df, "PE_AMS"))
```
Oxygen levels, `PE_O2` are calculated in the form of percentage. In this case, there is a mixture of pure numbers and numbers ending with `%`  resulting in the variable to be treated as  a character variable.  `%` will be omitted and the variable will be converted to a numeric variable. 
```{r}
(eda_c(df, "PE_O2"))
# clean  up `PE_O2` 
df<-df %>% mutate(PE_O2= as.numeric(str_replace_all(PE_O2,pattern="%", replacement = "")))
```

## Missing `PE_` values
Now, all the `PE_` variables are in numeric form and the proportion of `NA` can be appropriately calculated. Oxygen levels `PE_O2` has the highest proportion of missing values, >30% values are missing. `PE_O2` will be dropped. 
```{r}
(eda_n_NAplt(df,"PE"))

df<-df %>% select(-PE_O2)
```

## Outlier `PE_` values 
The following variables have unrealistic outliers:

-	Temperature, `PE_temp`. Outliers >50’C will be explored 
-	Breathing rate, `PE_RR`. Outliers of >50 breaths per minute will be explored 
-	Diastolic blood pressure, `PE_BP_D`. There is only one observation with a diastolic blood pressure >300, this observation will be removed. 

```{r}
pe_selected<-eda_n_NAcutoff(df, "PE", 0, 0.3)

(eda_n_outlier(df,pe_selected))

df<-df %>% filter(PE_BP_D<300)
```

### Further investigation of outliers 
The 90-ish values stand out for both `PE_temp` and `PE_RR`. A frequency count will be done.
```{r}
(df %>% filter(PE_temp>50) %>% ggplot(aes(PE_temp)) + geom_histogram(bins=round(sqrt(nrow(df)))))

(df %>% filter(PE_RR>50) %>% ggplot(aes(PE_RR)) + geom_histogram(bins=round(sqrt(nrow(df)))))
```
<br>

`99` is the most common value. Similar to previous numeric variables where `99` is an outlier, it will be converted to `NA`. For `PE_temp`, the values `363` and `384`, are likely missing a decimal point (It is more likely your body’s temperature is 36.3’C instead of 363’C) . 
```{r}
# PE_temp
(df %>% filter(PE_temp>50) %>% group_by(PE_temp) %>% summarise(n(), .groups="drop"))

# PE_RR
(df %>% filter(PE_RR>50) %>% group_by(PE_RR) %>% summarise(n(), .groups="drop"))
```
The rest of the outliers will take a plausible maximum value based on the 90th-95th percentile. 
```{r}
# 90-ish percentile 
(quantile(df$PE_temp, probs = seq(0,1,.05), na.rm = T))
(quantile(df$PE_RR, probs = seq(0,1,.05), na.rm = T))

# clean up PE_temp and PE_RR
df<-df %>% mutate(PE_temp=na_if(PE_temp, 99), PE_RR=na_if(PE_RR, 99),
          PE_temp=if_else(PE_temp==363, 36.3, PE_temp), PE_temp=if_else(PE_temp==384, 38.4, PE_temp),
          PE_temp=if_else(PE_temp>50, 40, PE_temp), PE_RR=if_else(PE_RR>50, 35, PE_RR)) 
```

# To be continued....
Before this post becomes too long, EDA for the remaining categories

- lab findings `Lab_`
- cultures `CS_`
- antibiotics `Abx_`
- continiuum of care state `Care_`
- vaccine `V_`

will be done in the next post. 
```{r}
save(df, file = "CAP_EDA1.RData")
```